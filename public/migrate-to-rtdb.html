<!DOCTYPE html>
<html>
<head>
    <title>Firestore â†’ RTDB Migration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { opacity: 0.9; }
        .result {
            margin-top: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { background: #dcfce7; border: 2px solid #22c55e; }
        .error { background: #fee2e2; border: 2px solid #ef4444; }
        .warning { background: #fef3c7; border: 2px solid #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ Firestore â†’ Realtime Database Migration</h1>
        <p>Firestore'daki verileri Realtime Database'e kopyalayÄ±n (Firestore cache bug workaround)</p>
        
        <div>
            <button onclick="migrateUsers()">1ï¸âƒ£ KullanÄ±cÄ±larÄ± Migrate Et</button>
            <button onclick="testRTDB()">2ï¸âƒ£ RTDB'yi Test Et</button>
            <button onclick="testLogin()">3ï¸âƒ£ Login Test</button>
        </div>
        
        <div id="result" class="result"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDT23p3KDd3pQf13UiQOuIjmemyBlMYPBg",
            authDomain: "softielwebsite.firebaseapp.com",
            databaseURL: "https://softielwebsite-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "softielwebsite",
            storageBucket: "softielwebsite.firebasestorage.app",
            messagingSenderId: "876968672828",
            appId: "1:876968672828:web:b0f7ab34322bf14a044d39",
            measurementId: "G-GHEMBDDCZP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        window.migrateUsers = async function() {
            const result = document.getElementById('result');
            result.className = 'result';
            result.textContent = 'KullanÄ±cÄ±lar migrate ediliyor...';
            
            try {
                // Firestore'dan kullanÄ±cÄ±larÄ± al
                const usersCollection = collection(db, 'users');
                const snapshot = await getDocs(usersCollection);
                
                if (snapshot.empty) {
                    result.className = 'result warning';
                    result.textContent = 'âš ï¸ Firestore\'da kullanÄ±cÄ± bulunamadÄ±!';
                    return;
                }
                
                let migratedCount = 0;
                const users = {};
                
                // Her kullanÄ±cÄ±yÄ± RTDB'ye kopyala
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    users[doc.id] = {
                        id: doc.id,
                        name: data.name,
                        email: data.email,
                        password: data.password,
                        role: data.role,
                        isActive: data.isActive,
                        displayName: data.displayName || data.name,
                        bio: data.bio || '',
                        createdAt: data.createdAt || new Date().toISOString(),
                        updatedAt: data.updatedAt?.toDate?.().toISOString() || new Date().toISOString(),
                        lastLoginAt: data.lastLoginAt?.toDate?.().toISOString() || null
                    };
                    migratedCount++;
                }
                
                // RTDB'ye batch write
                const usersRef = ref(rtdb, 'users');
                await set(usersRef, users);
                
                result.className = 'result success';
                result.textContent = `âœ… ${migratedCount} kullanÄ±cÄ± baÅŸarÄ±yla migrate edildi!\n\n${JSON.stringify(users, null, 2)}`;
                
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ Hata:\n${error.message}\n\nStack:\n${error.stack}`;
            }
        };

        window.testRTDB = async function() {
            const result = document.getElementById('result');
            result.className = 'result';
            result.textContent = 'RTDB test ediliyor...';
            
            try {
                const usersRef = ref(rtdb, 'users');
                const snapshot = await get(usersRef);
                
                if (!snapshot.exists()) {
                    result.className = 'result warning';
                    result.textContent = 'âš ï¸ RTDB\'de kullanÄ±cÄ± bulunamadÄ±! Ã–nce migrate edin.';
                    return;
                }
                
                const users = snapshot.val();
                const userArray = Object.values(users);
                
                result.className = 'result success';
                result.textContent = `âœ… RTDB\'de ${userArray.length} kullanÄ±cÄ± bulundu:\n\n${JSON.stringify(userArray, null, 2)}`;
                
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ Hata:\n${error.message}`;
            }
        };

        window.testLogin = async function() {
            const result = document.getElementById('result');
            result.className = 'result';
            result.textContent = 'Login test ediliyor...';
            
            try {
                const usersRef = ref(rtdb, 'users');
                const snapshot = await get(usersRef);
                
                if (!snapshot.exists()) {
                    result.className = 'result error';
                    result.textContent = 'âŒ RTDB\'de kullanÄ±cÄ± yok!';
                    return;
                }
                
                const users = snapshot.val();
                const userArray = Object.values(users);
                
                // Test: Admin kullanÄ±cÄ±sÄ±nÄ± bul
                const adminUser = userArray.find(u => u.name === 'Admin');
                
                if (!adminUser) {
                    result.className = 'result error';
                    result.textContent = 'âŒ Admin kullanÄ±cÄ±sÄ± bulunamadÄ±!';
                    return;
                }
                
                result.className = 'result success';
                result.textContent = `âœ… Admin kullanÄ±cÄ±sÄ± bulundu!\n\nKullanÄ±cÄ± AdÄ±: ${adminUser.name}\nEmail: ${adminUser.email}\nÅifre: ${adminUser.password}\nRol: ${adminUser.role}\nAktif: ${adminUser.isActive}\n\nLogin iÃ§in:\n- KullanÄ±cÄ± AdÄ±: Admin\n- Åifre: ${adminUser.password}`;
                
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ Hata:\n${error.message}`;
            }
        };
    </script>
</body>
</html>

